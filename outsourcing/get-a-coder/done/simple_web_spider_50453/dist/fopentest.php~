<?php

function extract_links_stdio($url, $regexp)
{
  $parsed_url = parse_url($url);
  $host = $parsed_url['host'];
  $path = $parsed_url['path'];
  $dir = dirname($path);
  echo "$dir </br>\n";
  $input = file_get_contents($url) or die("Could not access $url");
  preg_match_all("/$regexp/siU", $input, $matches, PREG_SET_ORDER);
  $links = array();
  foreach ($matches as $match) {
    $links[] = $match[2];
    //array_push($links, $match[2]); // slower
  }
  return $links;
}

function extract_links_curl($url, $regexp)
{
  $parsed_url = parse_url($url);
  $proto = $parsed_url['scheme'];
  $host = $parsed_url['host'];
  $path = $parsed_url['path'];
  $base = substr($path, 0, strrpos($path, '/'));
  echo "path=$path, base=$base </br>\n";
  $ch = curl_init($url);
  if (!$ch) {
    echo "Buzz!!!";
    return;
  }
  $tmpfile = '/tmp/curl_test_home_page.txt';
  $fp = fopen($tmpfile, 'w');

  if ($host != "localhost") {
    curl_setopt($ch, CURLOPT_PROXY, "10.0.0.30:3128");
  }
  if ($fp) {
    curl_setopt($ch, CURLOPT_FILE, $fp);
  }
  curl_setopt($ch, CURLOPT_HEADER, false);

  curl_exec($ch);
  curl_close($ch);

  $input = file_get_contents($tmpfile) or die("Could not access $tmpfile");
  preg_match_all("/$regexp/siU", $input, $matches, PREG_SET_ORDER);
  $links = array();
  foreach ($matches as $match) {
    if (substr($match[2], 0, 1) == '#') {
      continue; // skip such stuffs
    }
    if (substr($match[2], 0, 1) == '/') { // absolute path
      $link = $proto . '://' . $host . $match[2];
    } else if (substr($match[2], 0, 5) == 'http:') {
      $link = $match[2];
    } else { // relative path
      $link = $proto . '://' . $host . $base . '/' . $match[2];
    }
    $links[] = $link;
    //array_push($links, $match[2]); // slower
  }
  return $links;
}

function extract_links($url, $method, $regexp)
{
  if ($method == "curl") {
    $links = extract_links_curl($url, $regexp);
  } else if ($method == "stdio") {
    $links = extract_links_stdio($url, $regexp);
  }

  return $links;
}

function process_links($links)
{
  foreach ($links as $link) {
    echo "$link <br>\n";
  }
}

//$url = 'http://localhost/mymanual/PHP5/html/function.substr.html';
//$url = 'http://localhost/index.html';
//$url = 'http://www.php.net/';
$url = 'http://www.brad.ac.uk/internal/';
//$url = 'songlist.php.html';
//$url = 'brad.internal.html';
$regexp = "<a\s[^>]*href=(\"??)([^\" >]*?)\\1[^>]*>(.*)<\/a>";
$links = extract_links($url, "curl", $regexp);
process_links($links);

?>
